import{r as f,j as t}from"./index-BnDS7Jbj.js";function o(r,n){return r&&r.querySelector(n)?.textContent?.trim()||null}function b(r,n){const e=o(r,n);if(!e)return null;const l=Number(e);return Number.isFinite(l)?l:null}function q(r){const n=new DOMParser().parseFromString(r,"application/xml");if(n.querySelector("parsererror"))throw new Error("Некорректный XML: проверьте структуру отчёта.");const e=n.querySelector("feedback")||n.documentElement;if(!e)throw new Error("Не найден корневой элемент DMARC-отчёта.");const l=e.querySelector("report_metadata"),c=o(l,"org_name")||void 0,d=o(l,"email")||void 0,x=o(l,"report_id")||void 0,p=b(e.querySelector("date_range"),"begin"),u=b(e.querySelector("date_range"),"end"),h=p?new Date(p*1e3).toISOString():void 0,g=u?new Date(u*1e3).toISOString():void 0,i=e.querySelector("policy_published"),j=o(i,"domain")||void 0,v=o(i,"adkim")||void 0,k=o(i,"aspf")||void 0,M=o(i,"p")||void 0,s=o(i,"sp")||void 0,a=b(i,"pct")||void 0,D=o(i,"fo")||void 0,m=[...e.querySelectorAll("record")];let A=0,w=0,F=0;const P=new Set;for(const y of m){const R=b(y,"row > count")||0;A+=R;const $=o(y,"row > source_ip");$&&P.add($);const N=o(y,"row > policy_evaluated > spf")?.toLowerCase(),_=o(y,"row > policy_evaluated > dkim")?.toLowerCase(),I=N==="pass",T=_==="pass";(I||T)&&(w+=R),!I&&!T&&(F+=R)}return{org:c,email:d,reportId:x,dateFrom:h,dateTo:g,domain:j,adkim:v,aspf:k,polP:M,polSp:s,pct:a,fo:D,total:A,passAligned:w,failBoth:F,sources:P.size}}function C(r,n){return n?`${(r/n*100).toFixed(1)}%`:"0%"}function S(r){return r?r==="s"?"строгое (strict)":r==="r"?"ослабленное (relaxed)":r:"не указано"}function L(){const[r,n]=f.useState(""),[e,l]=f.useState(null),[c,d]=f.useState(null),[x,p]=f.useState(!1),u=r.trim().length>0,h=u&&!x,g=(u||!!e||!!c)&&!x,i="/asap-trainer/samples/dmarc.xml",j=f.useMemo(()=>{if(!e)return[];const s=[];return(!e.polP||e.polP==="none")&&s.push("Опубликована политика p=none или политика отсутствует: для защиты домена рекомендуется переход на p=quarantine/p=reject с контролируемым увеличением покрытия (pct)."),typeof e.pct=="number"&&e.pct<100&&s.push(`Поле pct=${e.pct}: политика применяется к части трафика (этапное внедрение).`),e.adkim&&e.adkim!=="s"&&s.push(`adkim=${e.adkim}: выравнивание DKIM установлено как ${S(e.adkim)} (рекомендуется оценить целесообразность строгого режима).`),e.aspf&&e.aspf!=="s"&&s.push(`aspf=${e.aspf}: выравнивание SPF установлено как ${S(e.aspf)} (рекомендуется оценить целесообразность строгого режима).`),e.fo||s.push("Параметр fo не указан: целесообразно явно определить политику формирования форензик-отчётов (например, fo=1)."),e.total>0&&e.failBoth/e.total>.1&&s.push(`Доля сообщений без подтверждения DMARC (ни SPF, ни DKIM) повышенная: ${C(e.failBoth,e.total)}. Требуется анализ источников и корректировка политики/подписей.`),s},[e]);function v(){if(h){p(!0),d(null),l(null);try{const s=q(r);l(s)}catch(s){d(s?.message||"Ошибка разбора отчёта DMARC.")}finally{p(!1)}}}function k(){g&&(n(""),l(null),d(null))}function M(s){const a=s.target.files?.[0];if(!a)return;if(!/\.xml$/i.test(a.name)){alert("Допустимый формат: .xml (DMARC RUA aggregate)."),s.currentTarget.value="";return}const m=new FileReader;m.onload=()=>n(String(m.result||"")),m.readAsText(a)}return t.jsxs("div",{children:[t.jsx("h2",{children:"DMARC RUA Reader"}),t.jsx("p",{className:"hero-sub",style:{marginTop:0},children:"Цель: извлечение ключевых параметров агрегированного отчёта DMARC (RUA) и первичная оценка доли сообщений, не подтверждённых SPF/DKIM."}),t.jsxs("div",{style:{margin:"10px 0 14px",fontSize:13,color:"#94a3b8"},children:["Данные: XML-файл DMARC (aggregate). Рекомендуется загрузка файла (",t.jsx("code",{children:".xml"}),"). Образец:"," ",t.jsx("a",{href:i,download:!0,style:{color:"#9ab4ff"},children:"samples/dmarc.xml"}),"."]}),t.jsxs("div",{style:{display:"grid",gap:8,marginBottom:12},children:[t.jsx("textarea",{value:r,onChange:s=>n(s.target.value),rows:12,placeholder:"Вставьте содержимое DMARC-отчёта (XML) или загрузите файл через кнопку ниже.",style:{width:"100%",resize:"vertical",padding:10,borderRadius:10,border:"1px solid rgba(255,255,255,.10)",background:"var(--card)",color:"var(--text)",fontFamily:"ui-monospace, SFMono-Regular, Menlo, Consolas, monospace",fontSize:13,lineHeight:1.45}}),t.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"},children:[t.jsxs("label",{className:"btn ghost",style:{cursor:"pointer"},children:["Загрузить файл (.xml)",t.jsx("input",{type:"file",accept:".xml",onChange:M,style:{display:"none"}})]}),t.jsx("button",{className:"btn primary",onClick:v,disabled:!h,children:"Проанализировать"}),t.jsx("button",{className:"btn ghost",onClick:k,disabled:!g,title:"Очистить поле и результаты",children:"Очистить"})]})]}),c&&t.jsxs("div",{className:"card",style:{marginTop:12,borderColor:"rgba(198,40,40,.6)"},children:[t.jsx("div",{className:"t",children:"Ошибка"}),t.jsx("p",{style:{marginTop:6},children:c})]}),e&&t.jsxs("div",{className:"card",style:{marginTop:12},children:[t.jsx("div",{className:"t",children:"Сводка отчёта"}),t.jsxs("ul",{style:{margin:"6px 0 10px",paddingLeft:18},children:[e.org&&t.jsxs("li",{children:[t.jsx("b",{children:"Организация:"})," ",e.org,e.email?` (${e.email})`:""]}),e.reportId&&t.jsxs("li",{children:[t.jsx("b",{children:"Идентификатор отчёта:"})," ",e.reportId]}),(e.dateFrom||e.dateTo)&&t.jsxs("li",{children:[t.jsx("b",{children:"Период:"})," ",e.dateFrom||"?"," — ",e.dateTo||"?"]}),e.domain&&t.jsxs("li",{children:[t.jsx("b",{children:"Домен политики:"})," ",e.domain]}),(e.polP||e.polSp)&&t.jsxs("li",{children:[t.jsx("b",{children:"Политика:"})," p=",e.polP||"?",e.polSp?`, sp=${e.polSp}`:"",typeof e.pct=="number"?`, pct=${e.pct}`:"",e.fo?`, fo=${e.fo}`:""]}),(e.adkim||e.aspf)&&t.jsxs("li",{children:[t.jsx("b",{children:"Выравнивание:"})," adkim=",e.adkim||"?"," (",S(e.adkim),"); aspf=",e.aspf||"?"," (",S(e.aspf),")"]}),t.jsxs("li",{children:[t.jsx("b",{children:"Объём сообщений (count):"})," ",e.total]}),t.jsxs("li",{children:[t.jsx("b",{children:"Подтверждены SPF или DKIM:"})," ",e.passAligned," (",C(e.passAligned,e.total),")"]}),t.jsxs("li",{children:[t.jsx("b",{children:"Не подтверждены ни SPF, ни DKIM:"})," ",e.failBoth," (",C(e.failBoth,e.total),")"]}),t.jsxs("li",{children:[t.jsx("b",{children:"Уникальных источников (source_ip):"})," ",e.sources]})]}),t.jsx("div",{className:"t",style:{marginTop:10},children:"Выводы"}),j.length===0?t.jsx("p",{style:{marginTop:6,color:"#94a3b8"},children:"Существенных замечаний по заданным критериям не обнаружено. При необходимости используйте дополнительный анализ по источникам."}):t.jsx("ul",{style:{margin:"6px 0 0",paddingLeft:18},children:j.map((s,a)=>t.jsx("li",{style:{marginBottom:6},children:s},a))})]}),t.jsx("p",{style:{marginTop:12,fontSize:12,color:"#94a3b8"},children:"Примечание: разбор носит учебный характер и служит иллюстрацией первичной оценки DMARC-отчётов."})]})}export{L as default};
