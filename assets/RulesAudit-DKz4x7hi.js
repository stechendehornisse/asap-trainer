import{r as g,j as e}from"./index-BnDS7Jbj.js";function S(i){const t=i.replace(/\r\n/g,`
`).replace(/\r/g,`
`).split(`
`).filter(a=>a.trim().length>0);if(t.length===0)return{headers:[],rows:[]};function r(a){const m=[];let u="",h=!1;for(let l=0;l<a.length;l++){const c=a[l];c==='"'?h&&a[l+1]==='"'?(u+='"',l++):h=!h:c===","&&!h?(m.push(u),u=""):u+=c}return m.push(u),m.map(l=>l.trim())}const s=r(t[0]).map(a=>a.trim()),n=t.slice(1).map(r);return{headers:s,rows:n}}function L(i,t){const r=i.map(s=>s.trim().toLowerCase());return t.map(s=>{const n={};for(let a=0;a<r.length;a++)n[r[a]]=(s[a]??"").trim();return n})}function k(i){if(!i)return!1;const t=i.toLowerCase();return["true","yes","on","enabled","1"].includes(t)||t==="вкл"||t==="да"}function N(i,t,r){for(const s of t){const n=i[s];if(n&&r.test(n))return s}for(const[s,n]of Object.entries(i))if(n&&r.test(n))return s;return null}function R(i){const t=i.match(/<([^>]+)>/),r=t?t[1]:i,s=r.lastIndexOf("@");return s<0?null:r.slice(s+1).toLowerCase()||null}function T(i,t){const r=i.toLowerCase();if(/^https?:\/\//.test(r)||r.startsWith("mailto:"))return!0;const s=R(r)||r;return!(!s.includes(".")||t&&s.endsWith(t.toLowerCase())||s.endsWith(".local")||s.endsWith(".corp"))}function B(i,t){const r=["name","rule name","rule","название","имя"],s=["enabled","is enabled","включено","активно"],n=["conditions","condition","условия"],a=["actions","action","действия"];let m=0,u=0,h=0;const l=[];for(const c of i){m++;const p=r.map(x=>c[x]).find(Boolean)||c[""]||"(без названия)",b=s.map(x=>k(c[x])).find(Boolean)??!0;b?u++:h++;const j=n.map(x=>c[x]).filter(Boolean).join(" | ").toLowerCase(),d=Object.values(c).join(" | ").toLowerCase();if(N(c,a,/(forward|redirect|переадрес|пересыл)/i)){const x=d.match(/(?:mailto:|https?:\/\/|<[^>]+>|\S+@\S+\.\S+)/i),o=x?x[0]:"";o&&T(o,t)?l.push({level:"высокий",rule:p,text:"Наружная переадресация/редирект на внешний адрес/URL."}):l.push({level:"средний",rule:p,text:"Переадресация обнаружена (проверить назначение и необходимость)."})}/(permanent\s*delete|удалить навсегда)/i.test(d)?l.push({level:"высокий",rule:p,text:"Действие «удалить навсегда»: риск утраты входящих сообщений."}):/\b(delete|удалить)\b/i.test(d)&&l.push({level:"средний",rule:p,text:"Действие «удалить»: проверьте условия, чтобы исключить потерю легитимной почты."}),/(mark as read|пометить как прочитанное)/i.test(d)&&/(stop processing|прекратить обработку|stop rule)/i.test(d)&&l.push({level:"средний",rule:p,text:"«Пометить как прочитанное» + «Прекратить обработку»: риск скрытого обхода Inbox."}),/(invoice|payment|beneficiary|urgent|сч[её]т|оплат[аи]|получател[ья]|срочно)/i.test(j)&&l.push({level:"средний",rule:p,text:"Широкие тематические условия (счёт/оплата/срочно): возможна автоматизация BEC-сценариев."}),/(move to folder|переместить в папку)/i.test(d)&&!/inbox|входящие/i.test(d)&&l.push({level:"низкий",rule:p,text:"Перемещение писем в папки вне «Входящие»: проверьте обоснованность."}),+!!/(delete|удалить)/i.test(d)+ +!!/(mark as read|прочитан)/i.test(d)+ +!!/(move to folder|переместить)/i.test(d)>=2&&l.push({level:"средний",rule:p,text:"Комбинация скрывающих действий (delete/read/move): риск незаметной утраты сообщений."}),b||l.push({level:"низкий",rule:p,text:"Правило отключено: целесообразно удалить/задокументировать."})}return{total:m,enabled:u,disabled:h,findings:l}}function F(){const[i,t]=g.useState(""),[r,s]=g.useState(""),[n,a]=g.useState(null),[m,u]=g.useState(null),[h,l]=g.useState(!1),c=i.trim().length>0,p=c&&!h,b=(c||!!n||!!m)&&!h,j="/asap-trainer/samples/rules.csv",d=g.useMemo(()=>{if(!n)return[];const o={высокий:0,средний:1,низкий:2};return[...n.findings].sort((f,v)=>o[f.level]-o[v.level]||f.rule.localeCompare(v.rule))},[n]);function C(){if(p){l(!0),u(null),a(null);try{const{headers:o,rows:f}=S(i);if(o.length===0||f.length===0)throw new Error("Файл пуст или не содержит строк.");const v=L(o,f),y=B(v,r||void 0);a(y)}catch(o){u(o?.message||"Ошибка разбора CSV.")}finally{l(!1)}}}function w(){b&&(t(""),s(""),a(null),u(null))}function x(o){const f=o.target.files?.[0];if(!f)return;if(!/\.csv$/i.test(f.name)){alert("Допустимый формат: .csv (экспорт правил почтового ящика)."),o.currentTarget.value="";return}const y=new FileReader;y.onload=()=>t(String(y.result||"")),y.readAsText(f)}return e.jsxs("div",{children:[e.jsx("h2",{children:"Rules Audit"}),e.jsx("p",{className:"hero-sub",style:{marginTop:0},children:"Цель: первичная проверка экспортированных правил почтового ящика на предмет внешних переадресаций, скрывающих действий и «широких» условий, потенциально используемых в BEC-сценариях."}),e.jsxs("div",{style:{margin:"10px 0 14px",fontSize:13,color:"#94a3b8"},children:["Данные: CSV-экспорт правил ящика. Образец:"," ",e.jsx("a",{href:j,download:!0,style:{color:"#9ab4ff"},children:"samples/rules.csv"}),"."," ","Внутренний домен (необязательно):"," ",e.jsx("input",{value:r,onChange:o=>s(o.target.value),placeholder:"например, org-x.local или example.com",style:{marginLeft:6,padding:"4px 8px",borderRadius:8,border:"1px solid rgba(255,255,255,.10)",background:"var(--card)",color:"var(--text)"}})]}),e.jsxs("div",{style:{display:"grid",gap:8,marginBottom:12},children:[e.jsx("textarea",{value:i,onChange:o=>t(o.target.value),rows:10,placeholder:"Вставьте CSV-экспорт правил или загрузите файл через кнопку ниже.",style:{width:"100%",resize:"vertical",padding:10,borderRadius:10,border:"1px solid rgba(255,255,255,.10)",background:"var(--card)",color:"var(--text)",fontFamily:"ui-monospace, SFMono-Regular, Menlo, Consolas, monospace",fontSize:13,lineHeight:1.45}}),e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"},children:[e.jsxs("label",{className:"btn ghost",style:{cursor:"pointer"},children:["Загрузить файл (.csv)",e.jsx("input",{type:"file",accept:".csv",onChange:x,style:{display:"none"}})]}),e.jsx("button",{className:"btn primary",onClick:C,disabled:!p,children:"Проанализировать"}),e.jsx("button",{className:"btn ghost",onClick:w,disabled:!b,title:"Очистить поле и результаты",children:"Очистить"})]})]}),m&&e.jsxs("div",{className:"card",style:{marginTop:12,borderColor:"rgba(198,40,40,.6)"},children:[e.jsx("div",{className:"t",children:"Ошибка"}),e.jsx("p",{style:{marginTop:6},children:m})]}),n&&e.jsxs("div",{className:"card",style:{marginTop:12},children:[e.jsx("div",{className:"t",children:"Сводка"}),e.jsxs("ul",{style:{margin:"6px 0 10px",paddingLeft:18},children:[e.jsxs("li",{children:[e.jsx("b",{children:"Всего правил:"})," ",n.total]}),e.jsxs("li",{children:[e.jsx("b",{children:"Включено:"})," ",n.enabled," | ",e.jsx("b",{children:"Отключено:"})," ",n.disabled]})]}),e.jsx("div",{className:"t",style:{marginTop:10},children:"Замечания"}),d.length===0?e.jsx("p",{style:{marginTop:6,color:"#94a3b8"},children:"Существенных рисков по эвристикам прототипа не выявлено."}):e.jsx("ul",{style:{margin:"6px 0 0",paddingLeft:18},children:d.map((o,f)=>e.jsxs("li",{style:{marginBottom:6},children:[e.jsx("b",{style:{textTransform:"uppercase"},children:o.level})," — ",e.jsx("i",{children:o.rule}),": ",o.text]},f))})]}),e.jsx("p",{style:{marginTop:12,fontSize:12,color:"#94a3b8"},children:"Примечание: проверка носит учебный характер; используйте административные средства почтовой системы для окончательных выводов."})]})}export{F as default};
